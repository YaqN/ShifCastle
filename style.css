// ===== Confetti =====
const confettiCanvas=document.getElementById('confetti');
const ctx=confettiCanvas.getContext('2d');
function resizeCanvas(){confettiCanvas.width=innerWidth;confettiCanvas.height=innerHeight;}
addEventListener('resize',resizeCanvas);resizeCanvas();
let confettiPieces=[];
function burst(x=innerWidth/2,y=innerHeight/3,count=120){
  for(let i=0;i<count;i++){
    confettiPieces.push({x,y,vx:(Math.random()*2-1)*4,vy:Math.random()*-6-4,g:.12+Math.random()*.08,rot:Math.random()*Math.PI,vr:(Math.random()*2-1)*.1,size:6+Math.random()*6,color:Math.random()<.5?'#cc2035':(Math.random()<.7?'#e94a5a':'#c9ad63')});
  }
}
function tick(){
  ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  confettiPieces=confettiPieces.filter(p=>p.y<confettiCanvas.height+20);
  confettiPieces.forEach(p=>{
    p.vy+=p.g;p.x+=p.vx;p.y+=p.vy;p.rot+=p.vr;
    ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);
    ctx.fillStyle=p.color;ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size);ctx.restore();
  });
  requestAnimationFrame(tick);
}
tick();
document.getElementById('confettiBurst').addEventListener('click',()=>burst());

// ===== Checklist =====
const todoList=document.getElementById('todoList');
const todoForm=document.getElementById('todoForm');
const todoInput=document.getElementById('todoInput');
let todos=JSON.parse(localStorage.getItem('todos')||'[]');
function renderTodos(){
  todoList.innerHTML='';
  todos.forEach((t,i)=>{
    const li=document.createElement('li');
    li.className='todo-item'+(t.done?' done':'');
    const cb=document.createElement('input');
    cb.type='checkbox';cb.checked=t.done;
    const span=document.createElement('span');span.textContent=t.text;
    const del=document.createElement('button');
    del.textContent='✖';del.className='btn small outline';
    cb.addEventListener('change',()=>{t.done=cb.checked;save();});
    del.addEventListener('click',()=>{todos.splice(i,1);save();});
    li.append(cb,span,del);todoList.appendChild(li);
  });
}
function save(){localStorage.setItem('todos',JSON.stringify(todos));renderTodos();}
todoForm.addEventListener('submit',e=>{
  e.preventDefault();
  const v=todoInput.value.trim();
  if(!v)return;
  todos.push({text:v,done:false});
  todoInput.value='';save();
});
document.getElementById('clearDone').addEventListener('click',()=>{
  todos=todos.filter(t=>!t.done);save();
});
renderTodos();
document.getElementById('exportList').addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(todos)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download='checklist.json';a.click();
});
document.getElementById('importList').addEventListener('change',e=>{
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=()=>{try{todos=JSON.parse(r.result);save();}catch{}};
  r.readAsText(f);
});

// ===== Baking Timers =====
let tInt=null,remaining=0;
const timeLeft=document.getElementById('timeLeft');
function fmt(n){return String(n).padStart(2,'0');}
function show(){timeLeft.textContent=fmt(Math.floor(remaining/60))+':'+fmt(remaining%60);}
function chime(){new Audio('data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAChAAAAAAA=').play().catch(()=>{});}
document.querySelectorAll('.recipe').forEach(btn=>btn.addEventListener('click',()=>{
  remaining=parseInt(btn.dataset.min)*60+parseInt(btn.dataset.sec);
  if(tInt)clearInterval(tInt);show();
  tInt=setInterval(()=>{
    remaining--;show();
    if(remaining<=0){clearInterval(tInt);tInt=null;chime();burst(innerWidth/2,innerHeight*0.2,160);}
  },1000);
}));
document.getElementById('stopTimer').addEventListener('click',()=>{if(tInt)clearInterval(tInt);tInt=null;});

// ===== Photo Booth =====
const area=document.getElementById('polaroids');
const polaroids=[...document.querySelectorAll('.polaroid')];
polaroids.forEach((p,i)=>{
  p.style.left=20+i*220+'px';p.style.top=20+(i%2)*30+'px';
  p.addEventListener('dblclick',()=>p.classList.toggle('pinned'));
  p.addEventListener('mousedown',e=>{
    if(p.classList.contains('pinned'))return;
    const sx=e.clientX,sy=e.clientY,rect=p.getBoundingClientRect(),
    ox=sx-rect.left,oy=sy-rect.top;
    function move(ev){p.style.left=(ev.clientX-ox-area.getBoundingClientRect().left)+'px';
      p.style.top=(ev.clientY-oy-area.getBoundingClientRect().top)+'px';}
    function up(){removeEventListener('mousemove',move);removeEventListener('mouseup',up);}
    addEventListener('mousemove',move);addEventListener('mouseup',up);
  });
});
document.querySelector('.filter-row').addEventListener('change',e=>{
  const v=e.target.value;
  area.classList.remove('filter-none','filter-vintage','filter-dreamy','filter-bw');
  area.classList.add('filter-'+v);
});

// ===== Compliment Jar =====
const fortunesDefault=[
  'You bring calm to every situation.',
  'Your kindness always shines through.',
  'You have a steady way of making things better.',
  'People can count on you — and that matters.',
  'You show patience and care in everything you do.',
  'You make the day a little easier for everyone.'
];
let fortunes=JSON.parse(localStorage.getItem('fortunes')||'null')||fortunesDefault.slice();
function saveFortunes(){localStorage.setItem('fortunes',JSON.stringify(fortunes));}
document.getElementById('drawFortune').addEventListener('click',()=>{
  if(!fortunes.length)fortunes=fortunesDefault.slice();
  const idx=Math.floor(Math.random()*fortunes.length);
  const msg=fortunes.splice(idx,1)[0];
  document.getElementById('fortuneText').textContent=msg;
  saveFortunes();burst(innerWidth*0.6,innerHeight*0.65,80);
});
document.getElementById('addFortuneForm').addEventListener('submit',e=>{
  e.preventDefault();
  const v=document.getElementById('addFortune').value.trim();
  if(!v)return;
  fortunes.push(v);saveFortunes();e.target.reset();
});

// ===== Message =====
const noteEl=document.getElementById('loveNote');
const notePrev=document.getElementById('notePreview');
const savedNote=localStorage.getItem('loveNote')||'';
noteEl.value=savedNote;notePrev.textContent=savedNote;
noteEl.addEventListener('input',()=>{
  localStorage.setItem('loveNote',noteEl.value);
  notePrev.textContent=noteEl.value;
});
document.getElementById('copyNote').addEventListener('click',async()=>{
  try{await navigator.clipboard.writeText(noteEl.value);burst(innerWidth*0.7,innerHeight*0.65,60);}catch(e){}
});
document.getElementById('clearNote').addEventListener('click',()=>{
  noteEl.value='';notePrev.textContent='';localStorage.removeItem('loveNote');
});

// ===== Background Music =====
const audio=document.getElementById('player');
window.addEventListener('load',()=>{
  audio.volume=0.8;
  audio.play().catch(()=>{});
});

// Shortcut key
addEventListener('keydown',e=>{if(e.key.toLowerCase()==='c')burst();});
